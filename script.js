// Giri≈ü butonu
document.getElementById("loginBtn").addEventListener("click", async () => {
  const username = document
    .getElementById("usernameInput")
    .value.trim()
    .toLowerCase();
  const errorBox = document.getElementById("loginError");

  if (!username) {
    errorBox.textContent = "L√ºtfen kullanƒ±cƒ± adƒ±nƒ±zƒ± girin.";
    return;
  }

  try {
    const userDoc = await db.collection("users").doc(username).get();

    if (userDoc.exists) {
      // Mevcut kullanƒ±cƒ± - bilgilerini al
      const userData = userDoc.data();
      currentUser = username;
      currentUserTotalScore = userData.totalScore || 0; // Toplam skoru al

      // localStorage'a kaydet
      localStorage.setItem("currentUser", currentUser);

      // Giri≈ü ba≈üarƒ±lƒ±ysa diƒüer ekranlara ge√ß
      document.getElementById("loginScreen").style.display = "none";
      document.getElementById("startScreen").style.display = "block";

      errorBox.textContent = "";
      showNotification(
        `üéâ Tekrar ho≈ü geldin, ${username}! Toplam skor: ${currentUserTotalScore}`
      );
    } else {
      // Yeni kullanƒ±cƒ± - kayƒ±t et
      await registerUser(username); // ‚úÖ doƒüru fonksiyon
      currentUser = username;
      currentUserTotalScore = 0;

      // localStorage'a kaydet
      localStorage.setItem("currentUser", currentUser);

      document.getElementById("loginScreen").style.display = "none";
      document.getElementById("startScreen").style.display = "block";

      errorBox.textContent = "";
      showNotification(`üéä Ho≈ü geldin, ${username}! ƒ∞lk kez oyun oynuyorsun.`);
    }
  } catch (err) {
    console.error("Hata olu≈ütu:", err);
    errorBox.textContent = "Bir hata olu≈ütu. L√ºtfen tekrar deneyin.";
  }
});
function showModernPopup(message, type = "info") {
  // √ñnceden varsa sil
  const existing = document.getElementById("modernPopup");
  if (existing) existing.remove();

  // Yeni popup olu≈ütur
  const popup = document.createElement("div");
  popup.id = "modernPopup";
  popup.textContent = message;

  // Tipine g√∂re renk ayarla
  let bg = "#2196f3"; // info
  if (type === "success") bg = "#4caf50";
  if (type === "error") bg = "#f44336";
  if (type === "warning") bg = "#ff9800";

  // Stilleri ekle
  popup.style.position = "fixed";
  popup.style.top = "20px";
  popup.style.left = "50%";
  popup.style.transform = "translateX(-50%)";
  popup.style.background = bg;
  popup.style.color = "#fff";
  popup.style.padding = "12px 24px";
  popup.style.borderRadius = "8px";
  popup.style.boxShadow = "0 2px 8px rgba(0,0,0,0.2)";
  popup.style.zIndex = "9999";
  popup.style.fontSize = "16px";
  popup.style.opacity = "0";
  popup.style.transition = "opacity 0.3s ease";

  // Ekrana ekle
  document.body.appendChild(popup);

  // G√∂r√ºn√ºr yap
  requestAnimationFrame(() => {
    popup.style.opacity = "1";
  });

  // Otomatik kapat
  setTimeout(() => {
    popup.style.opacity = "0";
    setTimeout(() => {
      popup.remove();
    }, 300);
  }, 3000);
}

async function registerUser(username) {
  await db.collection("users").doc(username).set({
    username: username,
    totalScore: 0,
    bestScore:  0,
    gamesPlayed: 0,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
}




async function updateScore(newScore) {
  if (!window.currentUser) return;

  const userRef = db.collection("users").doc(window.currentUser);
  const userSnap = await userRef.get();

  if (userSnap.exists) {
    const existingScore = userSnap.data().score;
    if (newScore > existingScore) {
      await userRef.update({ score: newScore });
    }
  }
}

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

// Oyun durumu
let gameStarted = false;
let player = { x: 200, y: 550, radius: 12, dir: 1, trail: [] };
let speed = 1.5; // Ba≈ülangƒ±√ß hƒ±zƒ± azaltƒ±ldƒ±
let score = 0;
let lastTime = performance.now(); // FPS farkƒ± i√ßin zaman takip
let isGameOver = false;
let obstacles = [];
let powerups = [];
let particles = [];
let animationId = null; // Animation frame kontrol√º i√ßin

// Baƒüƒ±mlƒ±lƒ±k mekanikleri
let streak = 0;
let level = 1;
let combo = 1;
let perfectHits = 0;
let sessionGames = 0;

let totalScore = parseInt(localStorage.getItem("totalScore") || "0");
let bestScore = parseInt(localStorage.getItem("bestScore") || "0");
let achievements = JSON.parse(localStorage.getItem("achievements") || "[]");
let dailyStreak = parseInt(localStorage.getItem("dailyStreak") || "0");
let lastPlayDate = localStorage.getItem("lastPlayDate") || "";

// UI elementleri
const scoreBoard = document.getElementById("scoreBoard");
const streakDisplay = document.getElementById("streak");
const levelDisplay = document.getElementById("level");
const comboDisplay = document.getElementById("combo");
const gameOverDiv = document.getElementById("gameOver");
const finalScore = document.getElementById("finalScore");
const personalBest = document.getElementById("personalBest");
const sessionStats = document.getElementById("sessionStats");
const achievementsDiv = document.getElementById("achievements");
const notification = document.getElementById("notification");
const startScreen = document.getElementById("startScreen");
const hud = document.getElementById("hud");

// Sabitler - Daha kolay oyun i√ßin ayarlar
const gapSize = 130; // Gap boyutu artƒ±rƒ±ldƒ±
const obstacleHeight = 20;
const minGapX = 60; // Minimum kenar bo≈üluƒüu artƒ±rƒ±ldƒ±
let maxGapX = canvas.width - gapSize - 60;
const minVerticalSpacing = 160; // Dikey bo≈üluk artƒ±rƒ±ldƒ±

function showWelcomePopup(message) {
  const popup = document.getElementById("welcomePopup");
  if (!popup) return;

  popup.textContent = message;
  popup.style.display = "block";

  // Kapatmak i√ßin bekle
  setTimeout(() => {
    popup.style.display = "none";
  }, 3000);
}

function resizeCanvas() {
  const gameContainer = document.getElementById("game");
  const rect = gameContainer.getBoundingClientRect();
  canvas.width = rect.width;
  canvas.height = rect.height;
  maxGapX = canvas.width - gapSize - 60;

  if (!gameStarted) {
    player.x = canvas.width / 2;
    player.y = canvas.height - 50;
  }
}

function startGame() {
  // √ñnceki oyunu temizle
  if (animationId) {
    cancelAnimationFrame(animationId);
  }

  gameStarted = true;
  isGameOver = false;
  startScreen.style.display = "none";
  hud.style.display = "block";
  gameOverDiv.style.display = "none";

  // Oyun deƒüi≈ükenlerini sƒ±fƒ±rla
  resetGameVariables();

  checkDailyStreak();
  draw();
}

function resetGameVariables() {
  player = {
    x: canvas.width / 2,
    y: canvas.height - 50,
    radius: 12,
    dir: 1,
    trail: [],
  };
  speed = 1.5; // Mobil i√ßin yava≈ü ba≈ülangƒ±√ß
  score = 0;
  level = 1;
  combo = 1;
  perfectHits = 0;
  streak = 0;
  obstacles = [];
  powerups = [];
  particles = [];
}

document
  .getElementById("showAchievementsBtn")
  .addEventListener("click", showScoreList);
// Kullanƒ±cƒ± bazlƒ± skor sistemi i√ßin deƒüi≈ükenler (mevcut deƒüi≈ükenlerin yerine)
let currentUser = localStorage.getItem("currentUser") || "";
let currentUserTotalScore = 0; // Bu satƒ±rƒ± ekleyin
let userScores = JSON.parse(localStorage.getItem("userScores") || "{}");

// Kullanƒ±cƒ± bazlƒ± skor fonksiyonlarƒ±
async function getUserTotalScore(username) {
  try {
    const userDoc = await db.collection("users").doc(username).get();
    if (userDoc.exists) {
      return userDoc.data().totalScore || 0;
    } else {
      console.warn(`Kullanƒ±cƒ± bulunamadƒ±: ${username}`);
      return 0;
    }
  } catch (error) {
    console.error("Toplam skor alƒ±nƒ±rken hata olu≈ütu:", error);
    return 0;
  }
}

function getUserBestScore(username) {
  return userScores[username]?.bestScore || 0;
}
async function updateUserScore(newScore) {
  if (!currentUser) return;

  try {
    // Firebase'i g√ºncelle
    await db
      .collection("users")
      .doc(currentUser)
      .update({
        totalScore: firebase.firestore.FieldValue.increment(newScore),
      });

    // Local deƒüi≈ükeni de g√ºncelle
    currentUserTotalScore += newScore;

    console.log(
      `Skor g√ºncellendi: +${newScore}, Yeni toplam: ${currentUserTotalScore}`
    );
  } catch (error) {
    console.error("Skor g√ºncellenirken hata:", error);
  }
}

function restartGame() {
  // √ñnceki animasyonu durdur
  if (animationId) {
    cancelAnimationFrame(animationId);
    animationId = null;
  }

  // Canvas'ƒ± yeniden boyutlandƒ±r
  resizeCanvas();

  // Oyun deƒüi≈ükenlerini sƒ±fƒ±rla
  resetGameVariables();

  // Oyun durumlarƒ±nƒ± ayarla
  isGameOver = false;
  gameStarted = true; // Bu satƒ±r eksikti!

  // UI elementlerini d√ºzenle
  gameOverDiv.style.display = "none";
  hud.style.display = "block";

  // Oyunu ba≈ülat
  draw();
}

function checkDailyStreak() {
  const today = new Date().toDateString();
  if (lastPlayDate !== today) {
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    if (lastPlayDate === yesterday.toDateString()) {
      dailyStreak++;
    } else {
      dailyStreak = 1;
    }
    localStorage.setItem("dailyStreak", dailyStreak.toString());
    localStorage.setItem("lastPlayDate", today);

    if (dailyStreak > 1) {
      showNotification(`üî• ${dailyStreak} g√ºnl√ºk seri!`);
      addAchievement(`${dailyStreak} g√ºnl√ºk seri!`);
    }
  }
}

function addAchievement(text) {
  if (!achievements.includes(text)) {
    achievements.push(text);
    localStorage.setItem("achievements", JSON.stringify(achievements));

    // Safe DOM manipulation with error handling
    try {
      if (achievementsDiv) {
        const el = document.createElement("div");
        el.className = "achievement";
        el.textContent = text;
        achievementsDiv.appendChild(el);

        setTimeout(() => {
          if (el && el.parentNode) {
            el.parentNode.removeChild(el);
          }
        }, 4000);
      }
    } catch (error) {
      console.log("Achievement display error:", error);
    }
  }
}

const returnToMenuBtn = document.getElementById("returnToMenuBtn");
if (returnToMenuBtn) {
  returnToMenuBtn.addEventListener("click", () => {
    returnToMenu();
  });
}

function showNotification(text, type = "error") {
  const notification = document.getElementById("notification");
  if (!notification) {
    console.warn("‚ùå #notification elementi bulunamadƒ±");
    return;
  }

  notification.textContent = text;
  notification.style.display = "block";
  
  // Mesaj t√ºr√ºne g√∂re renk
  switch(type) {
    case "success":
      notification.style.backgroundColor = "#4CAF50"; // Ye≈üil
      break;
    case "warning":
      notification.style.backgroundColor = "#FF9800"; // Turuncu
      break;
    case "error":
    default:
      notification.style.backgroundColor = "#f44336"; // Kƒ±rmƒ±zƒ±
      break;
  }
  
  notification.style.color = "white";

  // Fade animasyonu
  notification.classList.remove("fade-in");
  void notification.offsetWidth;
  notification.classList.add("fade-in");

  setTimeout(() => {
    notification.style.display = "none";
  }, 3000);
}

function createParticles(x, y, color) {
  for (let i = 0; i < 8; i++) {
    particles.push({
      x,
      y,
      vx: (Math.random() - 0.5) * 6,
      vy: (Math.random() - 0.5) * 6,
      life: 40,
      color,
    });
  }
}

function updateParticles() {
  particles = particles.filter((p) => {
    p.x += p.vx;
    p.y += p.vy;
    return --p.life > 0;
  });
}

function drawParticles() {
  for (let p of particles) {
    ctx.save();
    ctx.globalAlpha = p.life / 40;
    ctx.fillStyle = p.color;
    ctx.beginPath();
    ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();
  }
}

function createPowerup() {
  if (Math.random() < 0.08) {
    powerups.push({
      x: Math.random() * (canvas.width - 40) + 20,
      y: -20,
      type: Math.random() < 0.5 ? "score" : "slow",
      collected: false,
    });
  }
}

function drawPowerups(deltaTime) {
  for (let p of powerups) {
    p.y += speed * deltaTime;
    ctx.save();
    ctx.font = "20px Arial";
    ctx.textAlign = "center";
    ctx.fillStyle = p.type === "score" ? "#FFD700" : "#00FF00";
    ctx.fillText(p.type === "score" ? "üíé" : "‚è∞", p.x, p.y);
    ctx.restore();

    const d = Math.hypot(player.x - p.x, player.y - p.y);
    if (d < player.radius + 15 && !p.collected) {
      p.collected = true;
      createParticles(p.x, p.y, p.type === "score" ? "#FFD700" : "#00FF00");
      if (p.type === "score") {
        const bonus = 50 * combo;
        score += bonus;
        showNotification(`üíé +${Math.floor(bonus)} bonus!`);
      } else {
        speed = Math.max(1.2, speed - 0.3); // Minimum hƒ±z artƒ±rƒ±ldƒ±
        showNotification("‚è∞ Yava≈ülatma!");
      }
    }
  }

  powerups = powerups.filter((p) => p.y < canvas.height + 50 && !p.collected);
}
// Game over fonksiyonunda Firebase skor g√ºncellemesi
async function gameOver() {
  const gameScore = Math.floor(score);
  console.log("üõë gameOver ba≈üladƒ± | Skor:", gameScore);
  
  // Debug - Deƒüerleri kontrol et
  console.log("üîç currentUser:", currentUser);
  console.log("üîç gameScore:", gameScore);
  console.log("üîç typeof currentUser:", typeof currentUser);
  console.log("üîç currentUser bo≈ü mu:", !currentUser);
  console.log("üîç gameScore <= 0 mu:", gameScore <= 0);

  if (!currentUser || gameScore <= 0) {
    console.warn("‚ùå currentUser bo≈ü veya skor 0 - Firebase √ßaƒürƒ±sƒ± yapƒ±lmayacak");
    console.warn("‚ùå currentUser:", currentUser, "| gameScore:", gameScore);
    return;
  }

  console.log("‚úÖ Kontroller ge√ßildi, devam ediliyor...");

  // Animasyonu durdur
  if (animationId) {
    cancelAnimationFrame(animationId);
    animationId = null;
    console.log("‚úÖ Animation durduruldu");
  }

  isGameOver = true;
  gameStarted = false;
  sessionGames++;

  console.log("‚úÖ Oyun durumu ayarlandƒ±");
  console.log("üìä isGameOver:", isGameOver);
  console.log("üìä gameStarted:", gameStarted);
  console.log("üìä sessionGames:", sessionGames);

  hud.style.display = "none";
  gameOverDiv.style.display = "block";
  
  console.log("‚úÖ UI elementleri ayarlandƒ±");

  try {
    console.log("üîÑ Firebase √ßaƒürƒ±sƒ± ba≈ülatƒ±lƒ±yor...");
    console.log("üì§ G√∂nderilecek veriler - User:", currentUser, "| Score:", gameScore);
    
    const result = await updateAllUserStatsFirebase(currentUser, gameScore);
    
    console.log("üìà Firebase sonucu alƒ±ndƒ±:", result);
    console.log("üèÜ Yeni rekor mu:", result.isNewRecord);
    console.log("üìä En iyi skor:", result.bestScore);
    console.log("üìä Toplam skor:", result.totalScore);
    console.log("üìä Oynama sayƒ±sƒ±:", result.gamesPlayed);

    // UI G√ºncellemeleri
    if (finalScore) {
      const message = result.isNewRecord
        ? "üèÜ YENƒ∞ REKOR! üèÜ<br>"
        : "üéÆ Oyun Bitti!<br>";
      finalScore.innerHTML = message + `Skorun: ${gameScore}`;
      console.log("‚úÖ Final score g√ºncellendi:", finalScore.innerHTML);
    } else {
      console.warn("‚ö†Ô∏è finalScore elementi bulunamadƒ±");
    }

    if (personalBest) {
      personalBest.innerHTML = `ü•á En ƒ∞yi: ${result.bestScore}`;
      console.log("‚úÖ Personal best g√ºncellendi:", personalBest.innerHTML);
    } else {
      console.warn("‚ö†Ô∏è personalBest elementi bulunamadƒ±");
    }

    if (sessionStats) {
      sessionStats.innerHTML = `üìä ${currentUser} toplam: ${result.totalScore} | Oynama: ${result.gamesPlayed}`;
      console.log("‚úÖ Session stats g√ºncellendi:", sessionStats.innerHTML);
    } else {
      console.warn("‚ö†Ô∏è sessionStats elementi bulunamadƒ±");
    }

    console.log("‚úÖ T√ºm UI g√ºncellemeleri tamamlandƒ±");
    console.log("‚úÖ Firebase verileri ba≈üarƒ±yla kaydedildi");

  } catch (err) {
    console.error("üî• Firebase g√ºncelleme hatasƒ±:", err);
    console.error("üî• Hata detaylarƒ±:", err.message);
    console.error("üî• Hata stack:", err.stack);
    
    // Hata durumunda UI'yi yine de g√ºncelle (offline durumu i√ßin)
    if (finalScore) {
      finalScore.innerHTML = `üéÆ Oyun Bitti!<br>Skorun: ${gameScore}`;
    }
    if (personalBest) {
      personalBest.innerHTML = `ü•á En ƒ∞yi: --`;
    }
    if (sessionStats) {
      sessionStats.innerHTML = `üìä Baƒülantƒ± hatasƒ± - Veriler kaydedilemedi`;
    }
  }

  console.log("üèÅ gameOver() fonksiyonu tamamlandƒ±");
}


async function updateAllUserStatsFirebase(username, newScore) {
  try {
    console.log(`üì§ ${username} i√ßin t√ºm veriler g√ºncelleniyor...`);
    console.log(`üéØ Yeni skor: ${newScore}`);
    
    const userRef = db.collection("users").doc(username);
    const userDoc = await userRef.get();
    
    let userData = {
      bestScore: 0,
      totalScore: 0,
      gamesPlayed: 0,
      username: username,
      createdAt: new Date()
    };
    
    // Mevcut verileri al
    if (userDoc.exists) {
      userData = { ...userData, ...userDoc.data() };
    }
    
    // G√ºncellemeleri yap
    const updatedData = {
      ...userData,
      totalScore: (userData.totalScore || 0) + newScore,
      gamesPlayed: (userData.gamesPlayed || 0) + 1,
      lastPlayed: new Date()
    };
    
    // Best score kontrol√º
    let isNewRecord = false;
    if (newScore > (userData.bestScore || 0)) {
      updatedData.bestScore = newScore;
      isNewRecord = true;
    }
    
    console.log('üìä G√ºncellenecek veriler:', updatedData);
    
    // Firebase'e g√∂nder
    await userRef.set(updatedData, { merge: true });
    
    console.log('‚úÖ Firebase g√ºncelleme ba≈üarƒ±lƒ±');
    
    return {
      isNewRecord: isNewRecord,
      totalScore: updatedData.totalScore,
      gamesPlayed: updatedData.gamesPlayed,
      bestScore: updatedData.bestScore
    };
    
  } catch (error) {
    console.error('‚ùå Firebase g√ºncelleme hatasƒ±:', error);
    return {
      isNewRecord: false,
      totalScore: currentUserTotalScore + newScore,
      gamesPlayed: 0,
      bestScore: 0
    };
  }
}
// Firebase'den skor listesini √ßekme
async function showFirebaseScoreList() {
  try {
    const list = document.getElementById("scoreItems");
    if (!list) return;

    list.innerHTML = "<li>Y√ºkleniyor...</li>";

    // En y√ºksek skorlarƒ± √ßek
    const snapshot = await db
      .collection("users")
      .orderBy("bestScore", "desc")
      .limit(10)
      .get();

    list.innerHTML = "";

    if (snapshot.empty) {
      list.innerHTML = "<li>Hen√ºz hi√ß kullanƒ±cƒ± yok.</li>";
    } else {
      let rank = 1;
      snapshot.forEach((doc) => {
        const userData = doc.data();
        const li = document.createElement("li");

        // Emoji ve renk sistemi
        let rankEmoji = "";
        if (rank === 1) rankEmoji = "ü•á";
        else if (rank === 2) rankEmoji = "ü•à";
        else if (rank === 3) rankEmoji = "ü•â";
        else rankEmoji = `${rank}.`;

        li.innerHTML = `
                   <span class="rank">${rankEmoji}</span>
                   <span class="username">${userData.username}</span>
                   <span class="best-score">${userData.bestScore || 0}</span>
                   <span class="total-score">(Toplam: ${
                     userData.totalScore || 0
                   })</span>
               `;

        if (userData.username === currentUser) {
          li.classList.add("current-user");
        }

        list.appendChild(li);
        rank++;
      });
    }

    const scoreListEl = document.getElementById("scoreList");
    if (scoreListEl) scoreListEl.style.display = "block";
  } catch (error) {
    console.error("Skor listesi y√ºkleme hatasƒ±:", error);
    const list = document.getElementById("scoreItems");
    if (list) {
      list.innerHTML = "<li>Skor listesi y√ºklenemedi.</li>";
    }
  }
}

// Event listener'ƒ± g√ºncelle
document
  .getElementById("showAchievementsBtn")
  .addEventListener("click", showFirebaseScoreList);
// Kullanƒ±cƒ± adƒ± kontrol fonksiyonu
async function checkUsernameAvailability(username) {
  try {
    const snapshot = await db.collection("users").doc(username).get();
    return !snapshot.exists; // True = kullanƒ±labilir, False = alƒ±nmƒ±≈ü
  } catch (error) {
    console.error("Kullanƒ±cƒ± adƒ± kontrol√º hatasƒ±:", error);
    return false;
  }
}

// Yeni kullanƒ±cƒ± kaydetme
async function registerUser(username) {
  try {
    // √ñnce kontrol et
    const isAvailable = await checkUsernameAvailability(username);
    if (!isAvailable) {
      throw new Error("Bu kullanƒ±cƒ± adƒ± zaten alƒ±nmƒ±≈ü!");
    }

    // Kullanƒ±cƒ±yƒ± kaydet
    await db.collection("users").doc(username).set({
      username: username,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      totalScore: 0,
      bestScore: 0,
      gamesPlayed: 0,
    });

    return true;
  } catch (error) {
    console.error("Kullanƒ±cƒ± kayƒ±t hatasƒ±:", error);
    throw error;
  }
}

// Ger√ßek zamanlƒ± kullanƒ±cƒ± adƒ± kontrol√º
function setupRealtimeUsernameCheck() {
  const usernameInput = document.getElementById("usernameInput");
  const loginError = document.getElementById("loginError");
  const loginBtn = document.getElementById("loginBtn");

  let checkTimeout;

  usernameInput.addEventListener("input", (e) => {
    const username = e.target.value.trim();

    // √ñnceki timeout'u temizle
    clearTimeout(checkTimeout);

    if (username.length < 2) {
      loginError.textContent = "Kullanƒ±cƒ± adƒ± en az 2 karakter olmalƒ±dƒ±r.";
      loginBtn.disabled = true;
      return;
    }

    if (username.length > 20) {
      loginError.textContent = "Kullanƒ±cƒ± adƒ± en fazla 20 karakter olabilir.";
      loginBtn.disabled = true;
      return;
    }

    // √ñzel karakterleri kontrol et
    if (!/^[a-zA-Z0-9_]+$/.test(username)) {
      loginError.textContent = "Sadece harf, rakam ve _ kullanabilirsiniz.";
      loginBtn.disabled = true;
      return;
    }

    // Loading g√∂ster
    loginError.textContent = "Kontrol ediliyor...";
    loginError.style.color = "#ffa500";
    loginBtn.disabled = true;

    // 500ms sonra kontrol et (spam √∂nleme)
    checkTimeout = setTimeout(async () => {
      try {
        const isAvailable = await checkUsernameAvailability(username);
        if (isAvailable) {
          loginError.textContent = "‚úÖ Kullanƒ±cƒ± adƒ± kullanƒ±labilir!";
          loginError.style.color = "#4CAF50";
          loginBtn.disabled = false;
        } else {
          loginError.textContent = "‚ùå Bu kullanƒ±cƒ± adƒ± zaten alƒ±nmƒ±≈ü!";
          loginError.style.color = "#f44336";
          loginBtn.disabled = true;
        }
      } catch (error) {
        loginError.textContent = "Baƒülantƒ± hatasƒ±, tekrar deneyin.";
        loginError.style.color = "#f44336";
        loginBtn.disabled = true;
      }
    }, 500);
  });
}

function createObstacle() {
  const last = obstacles.at(-1);
  let gapX;
  let attempts = 0;

  // Daha g√ºvenli gap pozisyonu se√ßimi
  do {
    gapX = Math.random() * (maxGapX - minGapX) + minGapX;
    attempts++;
    if (attempts > 10) break; // Sonsuz d√∂ng√ºy√º engelle
  } while (last && Math.abs(gapX - last.gapX) < gapSize / 3); // Daha az kƒ±sƒ±tlama

  const y = last ? last.y - minVerticalSpacing : -obstacleHeight;
  obstacles.push({ y, gapX, passed: false });
}

function drawPlayer() {
  player.trail.push({ x: player.x, y: player.y });
  if (player.trail.length > 10) player.trail.shift();

  for (let i = 0; i < player.trail.length; i++) {
    ctx.save();
    ctx.globalAlpha = (i / player.trail.length) * 0.6;
    ctx.beginPath();
    ctx.arc(
      player.trail[i].x,
      player.trail[i].y,
      player.radius * (i / player.trail.length),
      0,
      Math.PI * 2
    );
    ctx.fillStyle = combo > 5 ? "#FFD700" : "#fff";
    ctx.fill();
    ctx.restore();
  }

  ctx.save();
  ctx.beginPath();
  ctx.arc(player.x, player.y, player.radius, 0, Math.PI * 2);
  ctx.fillStyle = combo > 5 ? "#FFD700" : "#fff";
  ctx.shadowColor = combo > 5 ? "#FFD700" : "#1D77C0";
  ctx.shadowBlur = 12 + combo * 2;
  ctx.fill();
  ctx.restore();
}

function drawObstacles(deltaTime) {
  ctx.save();
  ctx.fillStyle = "rgba(255,255,255,0.9)";
  ctx.shadowColor = "#13294B";
  ctx.shadowBlur = 8;

  for (let obs of obstacles) {
    ctx.fillRect(0, obs.y, obs.gapX, obstacleHeight);
    ctx.fillRect(
      obs.gapX + gapSize,
      obs.y,
      canvas.width - (obs.gapX + gapSize),
      obstacleHeight
    );
    obs.y += speed * deltaTime;

    if (!obs.passed && obs.y > player.y) {
      obs.passed = true;
      streak++;
      combo = Math.min(combo + 0.2, 8); // Combo artƒ±≈üƒ± azaltƒ±ldƒ±
      perfectHits++;
      const centerX = obs.gapX + gapSize / 2;
      const distance = Math.abs(player.x - centerX);
      const bonus = Math.floor(10 * combo);
      score += bonus;

      if (distance < 30) {
        // Perfect hit aralƒ±ƒüƒ± geni≈ületildi
        const perfectBonus = Math.floor(20 * combo);
        score += perfectBonus;
        createParticles(player.x, player.y, "#FFD700");
        showNotification(`‚≠ê M√ºkemmel! +${perfectBonus + bonus}`);
      } else {
        createParticles(player.x, player.y, "#ffffff");
      }

      checkAchievements();
    }
  }
  ctx.restore();
}

function drawBackgroundElements() {
  const t = Date.now() * 0.001;
  ctx.save();
  ctx.strokeStyle = "rgba(255, 255, 255, 0.1)";
  ctx.lineWidth = 1;
  for (let i = 0; i < canvas.height; i += 50) {
    const offset = Math.sin(t + i * 0.01) * 10;
    ctx.beginPath();
    ctx.moveTo(0, i + offset);
    ctx.lineTo(canvas.width, i + offset);
    ctx.stroke();
  }
  ctx.restore();
}

function checkAchievements() {
  if (streak === 10) addAchievement("üéØ 10 seri ge√ßi≈ü!");
  if (streak === 25) addAchievement("üî• 25 seri ge√ßi≈ü!");
  if (streak === 50) addAchievement("üëë 50 seri ge√ßi≈ü!");
  if (perfectHits === 5) addAchievement("‚≠ê 5 m√ºkemmel!");
  if (perfectHits === 15) addAchievement("üí´ 15 m√ºkemmel!");
  if (score > 500) addAchievement("üéä 500 puan!");
  if (score > 1000) addAchievement("üèÜ 1000 puan!");
  if (level === 5) addAchievement("üìà Seviye 5!");
  if (level === 10) addAchievement("üöÄ Seviye 10!");
  if (combo >= 5) addAchievement("‚ö° 5x Kombo!");
  if (combo >= 8) addAchievement("üí• 8x Kombo!");
}

function updateLevel() {
  const newLevel = Math.floor(score / 200) + 1; // Level artƒ±≈üƒ± yava≈ülatƒ±ldƒ±
  if (newLevel > level) {
    level = newLevel;
   speed += 9 * (1 / 60); // FPS ne olursa olsun yakla≈üƒ±k 0.15 gibi artar

    showNotification(`üÜô Seviye ${level}!`);
    createParticles(player.x, player.y, "#00FF00");
  }
}

function checkCollision() {
  // Daha hassas √ßarpƒ±≈üma kontrol√º - sadece yakƒ±n engelleri kontrol et
  const playerLeft = player.x - player.radius;
  const playerRight = player.x + player.radius;
  const playerTop = player.y - player.radius;
  const playerBottom = player.y + player.radius;

  for (let obs of obstacles) {
    // Sadece oyuncunun yakƒ±nƒ±ndaki engelleri kontrol et
    if (Math.abs(obs.y - player.y) > 50) continue;

    const obsTop = obs.y;
    const obsBottom = obs.y + obstacleHeight;
    const gapLeft = obs.gapX;
    const gapRight = obs.gapX + gapSize;

    // Oyuncu engelle √ßakƒ±≈üƒ±yor mu?
    if (playerBottom > obsTop && playerTop < obsBottom) {
      // Sol engelle √ßarpƒ±≈üma - daha toleranslƒ±
      if (playerRight < gapLeft + 5) return true;
      // Saƒü engelle √ßarpƒ±≈üma - daha toleranslƒ±
      if (playerLeft > gapRight - 5) return true;
    }
  }
  return false;
}

function updateUI() {
  if (scoreBoard) scoreBoard.textContent = "Skor: " + Math.floor(score);
  if (streakDisplay) streakDisplay.textContent = "üî• Seri: " + streak;
  if (levelDisplay) levelDisplay.textContent = "üìä Seviye: " + level;
  if (comboDisplay) comboDisplay.textContent = "‚ö° Kombo: x" + combo.toFixed(1);
}

function draw() {
  if (isGameOver || !gameStarted) {
    return;
  }

  try {
    // ZAMAN FARKINI HESAPLA
    const now = performance.now();
    const deltaTime = (now - lastTime) / 1000; // saniye cinsinden
    lastTime = now;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawBackgroundElements();
    drawPlayer();
    drawObstacles(deltaTime); // parametre ile g√∂nderilecek
    drawPowerups(deltaTime); // parametre ile g√∂nderilecek
    drawParticles();
    updateParticles();

    // Oyuncu hareketi
    const moveSpeed = speed * 1.2;
    player.x += player.dir * moveSpeed * deltaTime;

    // Kenarlarda zƒ±plama
    if (
      player.x - player.radius <= 0 ||
      player.x + player.radius >= canvas.width
    ) {
      player.dir *= -1;
      player.x = Math.max(
        player.radius,
        Math.min(canvas.width - player.radius, player.x)
      );
      createParticles(player.x, player.y, "#ffffff");
    }

    // √áarpƒ±≈üma kontrol√º
    try {
      if (checkCollision()) {
        gameOver();
        return;
      }
    } catch (error) {
      console.log("Collision check error:", error);
    }

    // Skor artƒ±≈üƒ±
    score += 0.1 * combo * deltaTime;
    updateLevel();
    updateUI();

    // Power-up olu≈üturma
    if (Math.random() < 0.005) createPowerup();

    // Yeni engel olu≈üturma
    if (
      obstacles.length === 0 ||
      obstacles.at(-1).y > -minVerticalSpacing * 0.8
    ) {
      createObstacle();
    }

    // Eski engelleri temizle
    obstacles = obstacles.filter(
      (obs) => obs.y < canvas.height + obstacleHeight
    );

    // Devam et
    animationId = requestAnimationFrame(draw);
  } catch (error) {
    console.log("Draw function error:", error);
    gameOver();
  }
}


// Instagram Payla≈üƒ±m Fonksiyonu
function shareScore() {
  const text = `üéØ IG√ú ZigZag Rota'da ${Math.floor(
    score
  )} puan aldƒ±m! üî• Seri: ${streak}, üìä Seviye: ${level} ${
    currentUser ? `- ${currentUser}` : ""
  }`;
  const instagramUsername = "ogrenci.dekanligi";
  const instagramUrl = "https://www.instagram.com/ogrenci.dekanligi/";

  // Debug i√ßin konsola yazdƒ±r
  console.log("Share fonksiyonu √ßalƒ±≈ütƒ±rƒ±lƒ±yor...");
  console.log("Payla≈üƒ±lacak metin:", text);

  // √ñnce skoru panoya kopyala
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard
      .writeText(text)
      .then(() => {
        console.log("Metin panoya kopyalandƒ±");
      })
      .catch((err) => {
        console.error("Panoya kopyalama hatasƒ±:", err);
        fallbackCopyTextToClipboard(text);
      });
  } else {
    fallbackCopyTextToClipboard(text);
  }

  // Mobil cihaz kontrol√º
  const isMobile =
    /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
      navigator.userAgent
    );

  if (isMobile) {
    console.log("Mobil cihaz tespit edildi");

    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

    if (isIOS) {
      const instagramAppUrl = `instagram://user?username=${instagramUsername}`;

      const iframe = document.createElement("iframe");
      iframe.style.display = "none";
      iframe.src = instagramAppUrl;
      document.body.appendChild(iframe);

      setTimeout(() => {
        document.body.removeChild(iframe);
        window.open(instagramUrl, "_blank");
      }, 1000);
    } else {
      try {
        const intentUrl = `intent://instagram.com/_u/${instagramUsername}/#Intent;package=com.instagram.android;scheme=https;end`;
        window.location.href = intentUrl;

        setTimeout(() => {
          window.open(instagramUrl, "_blank");
        }, 2000);
      } catch (error) {
        console.error("Instagram a√ßma hatasƒ±:", error);
        window.open(instagramUrl, "_blank");
      }
    }
  } else {
    console.log("Masa√ºst√º cihaz tespit edildi");
    const newWindow = window.open(instagramUrl, "_blank");

    if (
      !newWindow ||
      newWindow.closed ||
      typeof newWindow.closed == "undefined"
    ) {
      alert(
        "Pop-up engelleyici aktif! L√ºtfen bu site i√ßin pop-up'lara izin verin."
      );
      console.error("Pop-up engellendi");
    } else {
      console.log("Instagram sayfasƒ± a√ßƒ±ldƒ±");
    }
  }

  if (typeof showNotification === "function") {
    showNotification("üì± Instagram'a y√∂nlendirildi! Skor panoya kopyalandƒ±.");
  } else {
    console.log("üì± Instagram'a y√∂nlendirildi! Skor panoya kopyalandƒ±.");
  }
}

// Eski tarayƒ±cƒ±lar i√ßin fallback kopyalama fonksiyonu
function fallbackCopyTextToClipboard(text) {
  const textArea = document.createElement("textarea");
  textArea.value = text;

  // G√∂r√ºnmez yap ama eri≈üilebilir tut
  textArea.style.top = "0";
  textArea.style.left = "0";
  textArea.style.position = "fixed";
  textArea.style.opacity = "0";

  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();

  try {
    const successful = document.execCommand("copy");
    const msg = successful ? "ba≈üarƒ±lƒ±" : "ba≈üarƒ±sƒ±z";
    console.log("Fallback kopyalama " + msg);
  } catch (err) {
    console.error("Fallback kopyalama hatasƒ±", err);
  }

  document.body.removeChild(textArea);
}

// Payla≈ü butonuna event listener ekle
document.addEventListener("DOMContentLoaded", function () {
  const shareBtn = document.getElementById("shareScoreBtn");
  if (shareBtn) {
    shareBtn.addEventListener("click", shareScore);
    console.log("Payla≈ü butonu event listener'ƒ± eklendi");
  } else {
    console.error("shareScoreBtn bulunamadƒ±!");
  }
});

// Eski tarayƒ±cƒ±lar i√ßin fallback kopyalama fonksiyonu
function fallbackCopyTextToClipboard(text) {
  const textArea = document.createElement("textarea");
  textArea.value = text;

  // G√∂r√ºnmez yap ama eri≈üilebilir tut
  textArea.style.top = "0";
  textArea.style.left = "0";
  textArea.style.position = "fixed";
  textArea.style.opacity = "0";

  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();

  try {
    const successful = document.execCommand("copy");
    const msg = successful ? "ba≈üarƒ±lƒ±" : "ba≈üarƒ±sƒ±z";
    console.log("Fallback kopyalama " + msg);
  } catch (err) {
    console.error("Fallback kopyalama hatasƒ±", err);
  }

  document.body.removeChild(textArea);
}

// Kontroller
canvas.addEventListener(
  "touchstart",
  (e) => {
    e.preventDefault();
    if (!isGameOver && gameStarted) {
      player.dir *= -1;
     speed += 0.5 * (1 / 60); // Sabit deƒüer gibi davranƒ±r (ortalama 60 FPS'e g√∂re)
      createParticles(player.x, player.y, "#ffffff");
    }
  },
  { passive: false }
);

canvas.addEventListener("click", () => {
  if (!isGameOver && gameStarted) {
    player.dir *= -1;
    speed += 0.5 * (1 / 60); // Sabit deƒüer gibi davranƒ±r (ortalama 60 FPS'e g√∂re)
    createParticles(player.x, player.y, "#ffffff");
  }
});

document.addEventListener("keydown", (e) => {
  if (
    (e.code === "Space" || e.code === "ArrowLeft" || e.code === "ArrowRight") &&
    !isGameOver &&
    gameStarted
  ) {
    e.preventDefault();
    player.dir *= -1;
    speed += 0.5 * (1 / 60); // ‚úÖ Sabit hƒ±z artƒ±≈üƒ±

    createParticles(player.x, player.y, "#ffffff");
  }
});

function returnToMenu() {
  // Animation loop'u durdur
  if (animationId) {
    cancelAnimationFrame(animationId);
    animationId = null;
  }

  gameStarted = false;
  isGameOver = false;
  resizeCanvas();

  // Kullanƒ±cƒ± varsa ba≈ülangƒ±√ß ekranƒ±na, yoksa login ekranƒ±na git
  if (currentUser) {
    showStartScreen();
  } else {
    showLoginScreen();
  }
  document.getElementById("hud").style.display = "none";
  document.getElementById("gameOver").style.display = "none";
}

// Skor listesini g√∂sterme fonksiyonu
function showScoreList() {
  const list = document.getElementById("scoreItems");
  if (!list) return;

  list.innerHTML = "";

  // Kullanƒ±cƒ± skorlarƒ±nƒ± al ve sƒ±rala
  const sortedUsers = Object.entries(userScores)
    .map(([username, data]) => ({
      username: username,
      bestScore: data.bestScore,
    }))
    .sort((a, b) => b.bestScore - a.bestScore); // En y√ºksekten en d√º≈ü√ºƒüe

  if (sortedUsers.length === 0) {
    list.innerHTML = "<li>Hen√ºz hi√ß kullanƒ±cƒ± yok.</li>";
  } else {
    sortedUsers.forEach((user) => {
      const li = document.createElement("li");
      li.textContent = `${user.username} = ${user.bestScore}`;
      list.appendChild(li);
    });
  }

  const scoreListEl = document.getElementById("scoreList");
  if (scoreListEl) scoreListEl.style.display = "block";
}
function submitScore() {
  const username = document.getElementById("username").value.trim();
  const score = parseInt(document.getElementById("finalScore").innerText || 0);

  if (!username) {
    alert("Kullanƒ±cƒ± adƒ± bo≈ü olamaz.");
    return;
  }
}

// Login ekranƒ± fonksiyonlarƒ±

// Login ekranƒ± fonksiyonlarƒ±
function showLoginScreen() {
  document.getElementById("loginScreen").style.display = "flex";
  document.getElementById("startScreen").style.display = "none";
  document.getElementById("hud").style.display = "none";
  document.getElementById("gameOver").style.display = "none";
}

// Geli≈ümi≈ü login fonksiyonu
async function handleAdvancedLogin() {
  const usernameInput = document.getElementById("usernameInput");
  const loginError = document.getElementById("loginError");
  const loginBtn = document.getElementById("loginBtn");

  const username = usernameInput.value.trim().toLowerCase();
  const storedUser = localStorage.getItem("currentUser");
  let knownUsers = JSON.parse(localStorage.getItem("knownUsers") || "{}");

  if (!username) {
    showNotification("‚ö†Ô∏è L√ºtfen kullanƒ±cƒ± adƒ±nƒ±zƒ± girin.", "warning");
    return;
  }

  try {
    loginBtn.disabled = true;
    loginBtn.innerHTML = '<span class="btn-icon">‚è≥</span> Kontrol ediliyor...';

    const userSnapshot = await db.collection("users").doc(username).get();

    // Bu kullanƒ±cƒ± ba≈üka cihazda kayƒ±tlƒ±ysa ‚Üí izin verme
    if (userSnapshot.exists && !knownUsers[username]) {
      showModernPopup("Bu kullanƒ±cƒ± adƒ± ba≈üka bir cihazda kayƒ±tlƒ±. L√ºtfen farklƒ± bir kullanƒ±cƒ± adƒ± se√ßin.", "error");
      showNotification("‚ùå Bu kullanƒ±cƒ± adƒ± bu cihaza ait deƒüil.", "error");
      loginError.textContent = "Bu kullanƒ±cƒ± adƒ± bu cihaza ait deƒüil.";
      loginError.style.color = "#f44336";
      return;
    }

    // Yeni kullanƒ±cƒ± mƒ±?
    let isFirstTime = false;
    if (!userSnapshot.exists) {
      await registerUser(username);
      isFirstTime = true;
    }

    // Kullanƒ±cƒ±yƒ± tanƒ±mla
    currentUser = username;
    currentUserTotalScore = userSnapshot.data()?.totalScore || 0;

    // Kullanƒ±cƒ±yƒ± yerelde kaydet
    knownUsers[username] = true;
    localStorage.setItem("knownUsers", JSON.stringify(knownUsers));
    localStorage.setItem("currentUser", currentUser);

    // Giri≈ü ekranƒ±nƒ± kapat, ba≈ülangƒ±cƒ± g√∂ster
    showStartScreen();

    // Kar≈üƒ±lama mesajƒ±
    const welcomeText = isFirstTime
      ? `üéä Ho≈ü geldin, ${username}! ƒ∞lk kez oyun oynuyorsun.`
      : `üéâ Tekrar ho≈ü geldin, ${username}!`;

    showNotification(welcomeText, "success");

    // Popup animasyonlu g√∂ster
    const uppercaseUsername = username.toLocaleUpperCase("tr-TR");

    showWelcomePopup(
      isFirstTime
        ? `üéä Ho≈ü geldin ${username.toUpperCase("tr-TR")}!`
        : `üéâ Tekrar ho≈ü geldin ${username.toUpperCase("tr-TR")}!`
    );

    // Sayfada kar≈üƒ±lama metni g√ºncelle (isteƒüe baƒülƒ±)
    const welcomeMessage = document.getElementById("welcomeMessage");
    if (welcomeMessage) {
      welcomeMessage.textContent = welcomeText;
    }

  } catch (error) {
    console.error("Login hatasƒ±:", error);
    showNotification("üö® Giri≈ü hatasƒ± olu≈ütu. L√ºtfen tekrar deneyin.", "error");
  } finally {
    loginBtn.disabled = false;
    loginBtn.innerHTML = '<span class="btn-icon">üíæ</span> Kaydet ve Ba≈üla';
  }
}




// Modern popup fonksiyonu
function showModernPopup(message, type = 'error') {
  // Overlay olu≈ütur
  const overlay = document.createElement('div');
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    animation: fadeIn 0.2s ease;
  `;

  // Popup i√ßeriƒüi
  const popup = document.createElement('div');
  const iconMap = { error: '‚ùå', warning: '‚ö†Ô∏è', success: '‚úÖ' };
  
  popup.style.cssText = `
    background: white;
    border-radius: 15px;
    padding: 25px;
    max-width: 350px;
    width: 90%;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    animation: slideIn 0.3s ease;
  `;

  popup.innerHTML = `
    <div style="font-size: 40px; margin-bottom: 15px;">${iconMap[type] || '‚ùå'}</div>
    <div style="font-size: 16px; color: #333; margin-bottom: 20px; line-height: 1.4;">${message}</div>
    <button onclick="this.closest('[data-popup]').remove()" 
            style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; 
                   padding: 10px 25px; border-radius: 20px; font-size: 14px; font-weight: 600; 
                   cursor: pointer; transition: transform 0.2s ease;"
            onmouseover="this.style.transform='translateY(-1px)'" 
            onmouseout="this.style.transform='translateY(0)'">Tamam</button>
  `;

  overlay.setAttribute('data-popup', 'true');
  overlay.appendChild(popup);
  
  // CSS animasyonlarƒ± ekle
  if (!document.querySelector('#popup-animations')) {
    const style = document.createElement('style');
    style.id = 'popup-animations';
    style.textContent = `
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      @keyframes slideIn { from { transform: scale(0.8) translateY(-20px); opacity: 0; } 
                          to { transform: scale(1) translateY(0); opacity: 1; } }
    `;
    document.head.appendChild(style);
  }

  document.body.appendChild(overlay);
  
  // ESC ile kapatma
  const closeOnEsc = (e) => {
    if (e.key === 'Escape') {
      overlay.remove();
      document.removeEventListener('keydown', closeOnEsc);
    }
  };
  document.addEventListener('keydown', closeOnEsc);
}
// G√ºncellenmi≈ü showNotification fonksiyonu
function showNotification(text, type = "error") {
  const notification = document.getElementById("notification");
  if (!notification) {
    
    console.warn("‚ùå #notification elementi bulunamadƒ±");
    return;
  }

  notification.textContent = text;
  notification.style.display = "block";
  
  // Mesaj t√ºr√ºne g√∂re renk ayarlama
  switch(type) {
    case "success":
      notification.style.backgroundColor = "#4CAF50"; // Ye≈üil
      break;
    case "warning":
      notification.style.backgroundColor = "#FF9800"; // Turuncu
      break;
    case "error":
    default:
      notification.style.backgroundColor = "#f44336"; // Kƒ±rmƒ±zƒ±
      break;
  }
  
  notification.style.color = "white";

  // Fade animasyonu
  notification.classList.remove("fade-in");
  void notification.offsetWidth; // Reflow zorlamak i√ßin
  notification.classList.add("fade-in");

  setTimeout(() => {
    notification.style.display = "none";
  }, 3000);
}



function changeUser() {
  // Mevcut oyunu durdur
  if (animationId) {
    cancelAnimationFrame(animationId);
    animationId = null;
  }

  gameStarted = false;
  isGameOver = false;

  // ≈ûu anki kullanƒ±cƒ±yƒ± unut (cihaz ge√ßmi≈üi saklanacak)
  localStorage.removeItem("currentUser");

  // Login ekranƒ±na d√∂n
  showLoginScreen();

  // Giri≈ü alanƒ±nƒ± temizle
  const usernameInput = document.getElementById("usernameInput");
  if (usernameInput) {
    usernameInput.value = "";
  }
}


// DOMContentLoaded event listener'ƒ± - TEK YER!
document.addEventListener("DOMContentLoaded", async function () {
  console.log("üåê DOM y√ºklendi");

  // üß† localStorage'dan kullanƒ±cƒ±yƒ± al
  const storedUser = localStorage.getItem("currentUser");
  let currentUser = "";
  let currentUserTotalScore = 0;

  if (storedUser) {
    console.log("üîê Kaydedilmi≈ü kullanƒ±cƒ± bulundu:", storedUser);
    try {
      const userDoc = await db.collection("users").doc(storedUser).get();
      if (userDoc.exists) {
        const userData = userDoc.data();
        currentUser = storedUser;
        currentUserTotalScore = userData.totalScore || 0;
        console.log("‚úÖ Kullanƒ±cƒ±nƒ±n toplam skoru:", currentUserTotalScore);
        showStartScreen();
      } else {
        console.warn("‚ö†Ô∏è Kullanƒ±cƒ± Firebase'de bulunamadƒ±");
        localStorage.removeItem("currentUser");
        showLoginScreen();
      }
    } catch (error) {
      console.error("üö® Firebase'den kullanƒ±cƒ± verisi alƒ±namadƒ±:", error);
      showLoginScreen();
    }
  } else {
    console.log("üë§ Kayƒ±tlƒ± kullanƒ±cƒ± yok");
    showLoginScreen();
  }

  // ‚úÖ Login butonu
  const loginBtn = document.getElementById("loginBtn");
  if (loginBtn) {
    loginBtn.addEventListener("click", function (e) {
      e.preventDefault();
      handleAdvancedLogin();
    });
  }

  // ‚úÖ Enter ile login
  const usernameInput = document.getElementById("usernameInput");
  if (usernameInput) {
    usernameInput.addEventListener("keypress", function (e) {
      if (e.key === "Enter") {
        e.preventDefault();
        handleAdvancedLogin();
      }
    });
  }

  // ‚úÖ Skoru g√∂nder (submitScoreBtn varsa)
  const submitScoreBtn = document.getElementById("submitScoreBtn");
  if (submitScoreBtn) {
    submitScoreBtn.addEventListener("click", async () => {
      const username = currentUser || usernameInput.value.trim().toLowerCase();
      const scoreText = document.getElementById("finalScore")?.innerText || "0";
      const score = parseInt(scoreText.match(/\d+/)?.[0] || "0");

      if (!username || isNaN(score)) {
        alert("Ge√ßerli kullanƒ±cƒ± adƒ± veya skor bulunamadƒ±.");
        return;
      }

      const userRef = db.collection("scores").doc(username);

      try {
        const doc = await userRef.get();

        if (doc.exists) {
          const currentScore = doc.data().score || 0;
          const newScore = currentScore + score;

          await userRef.update({
            score: newScore,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          });

          alert(`Skor g√ºncellendi! Yeni toplam: ${newScore}`);
        } else {
          await userRef.set({
            username,
            score,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          });

          alert("Skor ba≈üarƒ±yla kaydedildi!");
        }
      } catch (error) {
        console.error("‚ùå Skor g√∂nderme hatasƒ±:", error);
        alert("Skor g√∂nderilemedi.");
      }
    });
  }

  // ‚úÖ Payla≈ü butonu
  const shareBtn = document.getElementById("shareScoreBtn");
  if (shareBtn) {
    shareBtn.addEventListener("click", shareScore);
  }

  // ‚úÖ Ba≈ülat / yeniden ba≈ülat butonlarƒ±
  const startMain = document.getElementById("startButtonMain");
  const startRestart = document.getElementById("startButtonRestart");

  if (startMain) startMain.addEventListener("click", startGame);
  if (startRestart) startRestart.addEventListener("click", restartGame);

  // ‚úÖ Kullanƒ±cƒ± deƒüi≈ütir
  const changeUserBtn = document.getElementById("changeUserBtn");
  if (changeUserBtn) changeUserBtn.addEventListener("click", changeUser);

  // ‚úÖ Skor listesi
  const showAchievementsBtn = document.getElementById("showAchievementsBtn");
  if (showAchievementsBtn)
    showAchievementsBtn.addEventListener("click", showScoreList);

  const closeScoreListBtn = document.getElementById("closeScoreList");
  if (closeScoreListBtn)
    closeScoreListBtn.addEventListener("click", hideScoreList);
});

function showStartScreen() {
  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("startScreen").style.display = "block";

  // Giri≈ü yapan kullanƒ±cƒ±yƒ± al
  const welcomeUser = currentUser || localStorage.getItem("currentUser") || "Oyuncu";

  // Mesajƒ± g√ºncelle
  const welcomeMessage = document.getElementById("welcomeMessage");
  if (welcomeMessage) {
    welcomeMessage.textContent = `üéâ Ho≈ü geldin, ${welcomeUser}!`;
  }
}

function hideScoreList() {
  const scoreListEl = document.getElementById("scoreList");
  if (scoreListEl) scoreListEl.style.display = "none";
}
async function loadLeaderboard() {
  const leaderboardList = document.getElementById("leaderboardList");
  leaderboardList.innerHTML = ""; // √ñnce temizle

  try {
    const snapshot = await db
      .collection("scores")
      .orderBy("score", "desc")
      .limit(3)
      .get();

    snapshot.forEach((doc, index) => {
      const data = doc.data();
      const li = document.createElement("li");
      li.textContent = `${index + 1}. ${data.username} - ${data.score} puan`;
      leaderboardList.appendChild(li);
    });
  } catch (error) {
    console.error("Liderlik tablosu y√ºklenemedi:", error);
  }
}

// Skor g√ºncelleme fonksiyonu (Firebase ile)
async function updateUserScoreFirebase(username, gameScore) {
  try {
    const userRef = db.collection("users").doc(username);
    const userDoc = await userRef.get();

    if (userDoc.exists) {
      const userData = userDoc.data();
      const newTotalScore = (userData.totalScore || 0) + Math.floor(gameScore);
      const currentBestScore = userData.bestScore || 0;
      const newBestScore = Math.max(currentBestScore, Math.floor(gameScore));
      const gamesPlayed = (userData.gamesPlayed || 0) + 1;

      // Kullanƒ±cƒ± verilerini g√ºncelle
      await userRef.update({
        totalScore: newTotalScore,
        bestScore: newBestScore,
        gamesPlayed: gamesPlayed,
        lastPlayed: firebase.firestore.FieldValue.serverTimestamp(),
      });

      // Oyun skorunu kaydet
      await db.collection("scores").add({
        username: username,
        score: Math.floor(gameScore),
        level: level,
        streak: streak,
        combo: combo,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      });

      return newBestScore === Math.floor(gameScore); // Yeni rekor mu?
    }

    return false;
  } catch (error) {
    console.error("Skor g√ºncelleme hatasƒ±:", error);
    return false;
  }
}

// Skor tablosunu Firebase'den √ßekme
async function showFirebaseScoreList() {
  try {
    const list = document.getElementById("scoreItems");
    if (!list) return;

    list.innerHTML = "<li>Y√ºkleniyor...</li>";

    // En y√ºksek skorlarƒ± √ßek
    const snapshot = await db
      .collection("users")
      .orderBy("bestScore", "desc")
      .limit(10)
      .get();

    list.innerHTML = "";

    if (snapshot.empty) {
      list.innerHTML = "<li>Hen√ºz hi√ß kullanƒ±cƒ± yok.</li>";
    } else {
      let rank = 1;
      snapshot.forEach((doc) => {
        const userData = doc.data();
        const li = document.createElement("li");

        // Emoji ve renk sistemi
        let rankEmoji = "";
        if (rank === 1) rankEmoji = "ü•á";
        else if (rank === 2) rankEmoji = "ü•à";
        else if (rank === 3) rankEmoji = "ü•â";
        else rankEmoji = `${rank}.`;

        li.innerHTML = `
                    <span class="rank">${rankEmoji}</span>
                    <span class="username">${userData.username}</span>
                    <span class="score">${userData.bestScore}</span>
                `;

        if (userData.username === currentUser) {
          li.classList.add("current-user");
        }

        list.appendChild(li);
        rank++;
      });
    }

    const scoreListEl = document.getElementById("scoreList");
    if (scoreListEl) scoreListEl.style.display = "block";
  } catch (error) {
    console.error("Skor listesi y√ºkleme hatasƒ±:", error);
    const list = document.getElementById("scoreItems");
    if (list) {
      list.innerHTML = "<li>Skor listesi y√ºklenemedi.</li>";
    }
  }
}
window.addEventListener("DOMContentLoaded", loadLeaderboard);
// Butonlar
console.log("script.js y√ºklendi");

const startMain = document.getElementById("startButtonMain");
const startRestart = document.getElementById("startButtonRestart");

if (startMain) {
  startMain.addEventListener("click", () => {
    startGame();
  });
}

if (startRestart) {
  startRestart.addEventListener("click", () => {
    restartGame();
  });
}

// Ba≈ülangƒ±√ß
window.addEventListener("load", resizeCanvas);
window.addEventListener("resize", resizeCanvas);
resizeCanvas();
